% !TEX encoding = UTF-8 Unicode

\documentclass{article}
\usepackage[french]{babel}
\author{Groupe 13}
\title{Compte-rendus SAÉ24}
% \date{9 Juin 2022}
\usepackage[margin=1in]{geometry}
\usepackage{subcaption}
\usepackage{listings}
\usepackage{minted}
\usepackage{graphicx}
\usepackage[T1]{fontenc}
\usepackage[colorlinks=true,linkcolor=black,anchorcolor=black,citecolor=black,filecolor=black,menucolor=black,runcolor=black,urlcolor=black]{hyperref}
%\setcounter{tocdepth}{1} % pour la profondeur de la ToC

\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0pt}
\rfoot{\thepage}
\lfoot{SAÉ24}

\renewcommand{\listoflistingscaption}{Table des codes}
\renewcommand{\listingscaption}{Code}

\begin{document}

\maketitle
\tableofcontents
\newpage
\listoffigures
\newpage
\listoflistings

\newpage
\section{Réseau}

\newpage
\section{Téléphonie}

\newpage
\section{Collecte}
    \subsection{Connexion à la base de données}
    Nous avons décidé d'utiliser la deuxième option du sujet, c'est à dire un script Python ajoutant directement les valeurs récupérées\footnote{Nous verrons dans la section \ref{section:web} comment nous avons déployé notre serveur MySQL}. 
    En Python il existe plusieurs moyen d'accéder à une base de données, ici nous avons utilisé \verb|mysqlclient|, la même librairie utilisée par Django.
    \begin{listing}[H]
        \begin{minted}[breaklines]{python}
try:
    db=_mysql.connect("mysql.rt13.lab","root","admin", "temp")
except OperationalError:
    db=_mysql.connect("mysql.rt13.lab","root","admin")
    db.query("CREATE DATABASE temp")
    db.query("USE temp")
        \end{minted}
        \caption{Connexion BDD}
        \label{mqtt:bdd-conn}
    \end{listing}
    Voici, en Code \ref{mqtt:bdd-conn}, l'extrait de notre script qui permet de se connecter à notre serveur MySQL. Le "try, except" permet ici de créer la base de données "temp" si elle n'existe pas. Après cela, nous utilisons des requêtes SQL pour créer les deux tables de notre base de données, nous nous attarderons sur cela dans la section \ref{section:web}.
    \subsection{Connexion au brocker MQTT}
    Pour nous connecter au Brocker MQTT, nous allons utiliser le paquet Python \verb|paho-mqtt| que nous pouvons installer avec \verb|pip install|.
    Une fois le paquet installé, nous pouvons créer un simple script pour nous abonner à notre topic ainsi que d'imprimer les messages dans le terminal.

    \begin{listing}[H]
        \begin{minted}[breaklines]{python}
import paho.mqtt.client as mqtt

def on_connect(client, userdata, flags, rc):
    print("Connected with result code "+str(rc))
    client.subscribe("IUT/Colmar/SAE24/Maison1")

def on_message(client, userdata, msg):
    print(msg.topic+" "+str(msg.payload))

client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message

client.connect("test.mosquitto.org", port=1883, keepalive=60)

client.loop_forever()
        \end{minted}
        \caption{Simple script imprimant les messages MQTT}
        \label{mqtt:code-exemple}
    \end{listing}
    On remarque que l'on crée deux fonctions \verb|on_connect| et \verb|on_message|, la première est exécutée lors de la connexion au brocker tandis que la deuxième est exécutée lors de la réception d'un message MQTT. 
    Nous pouvons donc utiliser ces fonctions pour nos analyses et nos opérations SQL.

    \subsection{Écriture d'un parser pour les données MQTT}
    Les données envoyées par les capteurs sont présentées sous un format \emph{csv} (Comma-separated values) comme en exemple ci-dessous (Code \ref{mqtt:raw-exemple}). 
    \begin{listing}[H]
        \begin{minted}[breaklines]{text}
Id=B8A5F3569EFF,piece=sejour,date=22/06/2022,time=21:23:53,temp=11.56
        \end{minted}
        \caption{Exemple de message brut}
        \label{mqtt:raw-exemple}
    \end{listing}
    Il est donc facile de séparer ces valeurs avec Python grâce à la méthode \verb|split(',')|. Nous remarquons que chaque valeur est précédée de \verb|=|. 
    Comme nous n'avons pas besoin de tout ce qui est avant le signe égal, nous pouvons utiliser la même méthode que précédemment pour ne garder uniquement les valeurs utiles.

    \begin{listing}[H]
        \begin{minted}[breaklines]{python}
mac_addr= payload[0].split("=")[1]
piece= payload[1].split("=")[1]
dt= datetime.strptime(payload[2].split("=")[1] + " " + payload[3].split("=")[1],
                    '%d/%m/%Y %H:%M:%S')
temp= payload[4].split("=")[1]
        \end{minted}
        \caption{Séparation des valeurs}
        \label{mqtt:separation-valeurs}
    \end{listing}
    En Code \ref{mqtt:separation-valeurs} nous utilisons également la méthode \verb|strptime(str, format)| de l'objet \emph{datetime}, qui nous permettra, en spécifiant le format de la date d'origine, d'importer la date en format ISO 8601 dans la base de données.
\newpage
\section{Web}
\label{section:web}
\end{document}